%!TEX root = head.tex

%\section{Monitoring History Inclusion}

\section{Reducing complete history membership to propositional SAT}\label{ssec:complete}

Given a formula $\psi$ representing a library $L$, 
checking whether a complete history $h$ belongs to $H(L)$ 
can be reduced to propositional satisfiability. The crux of this reduction
is the fact that a complete history $h$ is weaker than another history $h'$ iff
the two histories consist of exactly the same set of 
operations~\footnote{More precisely, there exists a bijection between the set of operations in $h$ and respectively $h'$.}
(this includes the fact that the operation labels are the same in both histories) 
and the order constraints of $h$ are included in the order constraints of $h'$.

Thus, given a complete history $h=\tup{O,<,f,\<Matching>}$, let $\varphi(h)$ be a history formula 
describing the order constraints, the labels, and the matching relation of $h$:
\begin{align*}
\varphi(h)::= & \hspace{-6mm}\bigwedge_{\scriptsize \begin{array}{c} m\in\<Methods>, o\in O\\f(o)=m(u)=>v\end{array}} \hspace{-4mm} m(o)\quad \land
		   \bigwedge_{\scriptsize \begin{array}{c} o,o'\in O\\f(o)=m(u)=>v\\f(o)=m'(v)=>v'\end{array}} \hspace{-6mm} \<Val>(o,o') \\
		   & \land\ \bigwedge_{o,o'\in O, \<Matching>(o,o')} \<Matching>(o,o')\quad \land\ \bigwedge_{o,o'\in O, o<o'} o< o'%\land \<PO>(<)
\end{align*}

Also, let $\<Dom>(O)::=\forall x. x\in O$ be a formula restricting the interpretation domain of every 
operation-identifier variable to the elements of $O$. The formula $x\in O$ is a syntactic sugar for 
$
\bigvee_{o\in O} x=o
$.

%Also, given $h$, let $F[h]$ be the HL formula $F$ where the relation symbol $<_k$ is replaced by $<$
%and the quantifiers are instantiated on the set of operations $O$, 
%i.e., every sub-formula $\exists x.\ G$ of $F$ is rewritten into
%\[
%\bigvee_{o\in O} G[x\mapsto o].
%\]

\begin{theorem}\label{th:satisfiability}
Let $h$ be a complete history and $\psi$ a history formula representing a library $L$.
Then,
\[
h\in H(L)\mbox{ iff }\varphi(h)\land \<Dom>(O)\land \psi\mbox{ is satisfiable.}
\]
\end{theorem}
\begin{proof}
($=>$) Let $h=\tup{O,<,f,\<Matching>}$. Since $h\models \psi$, there exists a relation $\poker\subseteq O\times O$
such that $\tup{h,\poker}\models\psi'$, which implies that $\tup{h,\poker}$ is a model of $\varphi(h)\land \psi'$.

($\Leftarrow$) Let $\tup{h',\poker}$ be a model of $\varphi(h)\land \<Dom>(O)\land \psi'$. By the definition of $\varphi(h)$, 
we obtain that $h\preceq h'$. Since $\psi'$ requires that $\poker$ is stronger than the order relation in $h'$,
we obtain that $\poker$ is also stronger than the order relation in $h$. Moreover, since $\tup{h',\poker}$ is a model
of $ \<Dom>(O)$, we get that $\poker$ is an order relation between elements of $O$.
Therefore, $\tup{h,\poker}$ is also a model of $\psi'$, which implies that $h$ is a model of $\psi$.
\end{proof}

The satisfiability of $\varphi(h)\land \<Dom>(O)\land \psi'$ can be reduced to propositional satisfiability since
the domain of the operation-identifier variables is fixed and the existential quantifiers can be replaced by finite 
disjunctions, i.e., every sub-formula $\exists x.\ A$ is replaced by 
$
\bigvee_{o\in O}\ A[x\mapsto o]
$.
The formula obtained by removing the existential quantifiers belongs to the EPR fragment
(also known as the Bernays-Sch\"{o}nfinkel class),  whose satisfiability is known to be reducible to
propositional satisfiability in polynomial time, provided that the quantifier count is fixed.
The EPR fragment consists of first-order
formulas with no occurrences of function symbols other than constants, and which  
when written in the prenex normal form have the quantifier prefix $\exists^*\forall^*$.
The formula $\varphi(h)\land \<Dom>(O)\land \psi'$ has no function symbols other than constants
and by removing the existential quantifiers, it has a quantifier prefix $\forall^*$.
Therefore, one can construct a boolean formula $\<ToBool>(h,\psi)$, which
is equi-satisfiable to $\varphi(h)\land \<Dom>(O)\land \psi'$.


\begin{corollary}\label{cor:satisfiability}

Let $h$ be a complete history and $\psi::=\exists\poker.\ \psi'$ a formula as in Figure~\ref{fig:logic}. Then,
\[
h\models \psi\mbox{ iff }\ \<ToBool>(h,\psi)\mbox{ is satisfiable.}
\]

\end{corollary}

\section{Handling pending operations}\label{ssec:pending}

The formulas $\psi$ defined in Section~\ref{sec:logic} describe only complete histories
of a library $L$ but, they can be used to check even whether a history $h$ with \emph{pending} operations 
belongs to $H(L)$. Essentially, one can enumerate all the possible ways of completing or removing
pending operations of $h$ and check whether the obtained histories satisfy the formula $\psi$. 
In general, this works if the kernel of $L$ is defined and it contains only executions with completed operations.

\begin{definition}

Let $h_1=\tup{O_1,<_1,f_1}$ and $h_2=\tup{O_2,<_2,f_2}$ be two histories. We say $h_2$ 
is a \emph{completion} of $h_1$, written $h_1\preceq_c h_2$, when

\begin{itemize}

  \item $h_2$ consists only of completed operations, i.e., for all $o\in O_2$, $f_2(o)=m(u)=>v$ and $v\neq \bot$, and 
  
  \item there exists an injection $g:O_2 -> O_1$ satisfying the properties in Definition~\ref{def:weaker_than}
  and $o_1<_2 o_2$ implies $g(o_1)<_2 g(o_2)$ for each $o_1,o_2\in O_2$.

\end{itemize}

\end{definition}

\begin{example}

Examples of completions.

\end{example}

\begin{example}

Show that the projection of a linearizable history over complete operations is not necessarily linearizable.

\end{example}


\begin{lemma}\label{lemma:pending_histories}

Let $L$ be a library such that $\ker L$ is defined and the operations of any execution in $\ker L$ are completed.
A history $h$ belongs to the histories $H(L)$ of a library $L$ iff there exists 
a history $h_c$ such that $h\preceq_c h_c$ and $h_c\in H(L)$.

\end{lemma}

\begin{proof}

($=>$) Let $h=\tup{O,<,f}$. By Lemma~\ref{lemma:kernel_histories}, $h\in H(L)$ implies that there exists 
a complete history $h'=\tup{O',<',f'}$ such that $h'\in H(\ker L)$ and $h\preceq h'$. 
Then, there exists an injection $g:O' -> O$ 
satisfying the properties in Definition~\ref{def:weaker_than}. We define $h_c=\tup{O',<_c,f'}$ 
such that $o<_c o'$ iff $g(o) < g(o')$. Clearly, $h\preceq_c h_c$ and $h_c\preceq h'$. The latter implies
$h_c\in H(L)$, which finishes the proof.

($\Leftarrow$) Since $h\preceq_c h_c$ implies $h\preceq h_c$, then by Lemma~\ref{downward-closed},
$h_c\in H(L)$ implies $h\in H(L)$.
\end{proof}

Though we seek to develop an efficient monitor that can check whether a history with pending
operations is a refinement violation, the result in Lemma~\ref{lemma:pending_histories}
leads to an exponential blow-up: the number of possible completions of a given history $h$
is in general exponential in the number of operations in $h$. Therefore, we introduce
a sound, but incomplete, decision procedure that avoids enumerating all completions of $h$.
Essentially, this works by constructing a formula which is weaker than all the first-order formulas
corresponding to completions of $h$ via Theorem~\ref{th:satisfiability}. Therefore, if this formula
is unsatisfiable, then there exists no completion of $h$ which is included in $H(L)$.

Thus, given a history $h=\tup{O,<,f}$, let $O_c\subseteq O$ be the set of completed operations
in $h$, i.e., 
\[
O_c=\set{o:f(o)=m(u)=>v,v\neq\bot}.
\]

An operation $o\in O$ is called \emph{obsolete} iff there exists no pending operation $o'\in O$ which 
overlaps with $o$, i.e., for all $o'\in O$, $\neg o<o'$ and $\neg o'<o$ implies
$f(o')\in O_c$. The set of obsolete operations in the history $h$ is denoted by $O_{ob}$.

\begin{lemma}\label{lemma:pref_obsolete}

Let $L$ be a library such that $\ker L$ is defined and the operations of any execution in $\ker L$ are completed.
Let $h_1=\tup{O_1,<_1,f_1}\in H(L)$ and $Ob$ a set of obsolete operations in $h_1$. Then, there exists a 
history $h_2=\tup{O_2,<_2,f_2}$ such that 

\begin{itemize}

	\item $h_2$ is a prefix of $h_1$ and $h_2\in H(L)$, 

	\item $h_2$ includes all operations in $Ob$ and no operation ordered by $h_1$ after all operations in $Ob$, i.e.,
	$Ob\subseteq O_2$ and for all $o\in O_2$ there exists $o'\in Ob$ such that $\neg o'<o$.
	
\end{itemize}

\end{lemma}

\begin{proof}

Since $h_1\in H(L)$, there exists a completion $h_{1,c}$ and a kernel history $h_3\in H(\ker L)$ such that
$h_1\preceq_c h_{1,c} \preceq h_3=\tup{O_3,<_3,f_3}$. Let $h_4=\tup{O_4,<_4,f_4}$ be a minimal prefix of $h_3$ that
includes all operations in $Ob$. We define $O_2=O_4$, $<_2=<_1 |_{O_4}$, and $f_2=f_1 |_{O_4}$.

Since $h_4$ is downward closed w.r.t. $<_3$ and any two operations in $O_4$ ordered by $<_1$ are 
also ordered by $<_3$, it follows that $h_2$ is downward closed w.r.t. $<_1$. 
%Every $o\in O_4$ is completed in $h_1$: 
Therefore, $h_2$ is a prefix of $h_1$.

Every operation $o\in O_4$ is completed in $h_1$: by definition, 
$h_1$ orders every obsolete operation before every pending operation $o'$,
and by the minimality of $h_4$, it follows that $O_4$ doesn't include pending operations
of $h_1$. This implies that $f_1 |_{O_4}=f_4$ which is enough to conclude that 
$h_2\preceq h_4$. By Lemma~\ref{lemma:kernel_histories_prefix}, $h_4\in H(\ker L)$ and consequently, 
$h_2\in H(L)$.

Assume by contradiction that $O_4$ includes an operation $o$ such that $o' <_1 o$ for each $o'\in Ob$.
Since $h_1\preceq h_3$, we obtain that $o' <_3 o$ for each $o'\in Ob$, which contradicts the minimality of
the prefix $h_4$.
\end{proof}


Let $\varphi_c(h)$ be a formula describing the order constraints
and the labels in $h$ but only for completed operations:
\[
\varphi_c(h)::= \bigwedge_{o\in O_c} f(o)\land \bigwedge_{o,o'\in O_c, o<o'} o< o'\land \<PO>(<)
\]
%The formula $\<PO>_c$ restricts the interpretation of the universally-quantified variables to
%complete operations:
%\<PO>_c(<)

Moreover, given a formula $\varphi::=\forall \vec{x}\ \exists \vec{y}.\ F$, where 
$F$ is defined as in Figure~\ref{fig:logic}, we define the formula $\varphi_{ob}$ that
restricts the interpretation of the universally quantified variables to obsolete operations
and the interpretation of the existentially quantified variables to complete operations:
\begin{align}
\varphi_{ob}::=\forall \vec{x}\ \exists \vec{y}.\ \bigwedge_{x\in\vec{x}}\ x\in O_{ob} => \big(\bigwedge_{y\in\vec{y}}\ y\in O_c \land F\big).
\end{align}

%\exists \poker.\ \big( < \subseteq \hspace{-1mm}\poker 
%    \land \<PO>(\poker)\land \forall \vec{x}\ \exists \vec{y}.\ F
    
Given a formula $\psi::=\exists\poker.\ \psi'$ as in Figure~\ref{fig:logic}, let $\psi'_{ob}$ be the formula
obtained from $\psi'$ by replacing the sub-formula $\varphi::=\forall \vec{x}\ \exists \vec{y}.\ F$
with $\varphi_{ob}$.

\begin{theorem}\label{th:satisfiability_pending}

Let $L$ be a library such that $\ker L$ is defined and the operations of any execution in $\ker L$ are completed.
Also, let $\psi::=\exists\poker.\ \psi'$ be a formula as in Figure~\ref{fig:logic} describing the set of 
complete histories $H_c(L)$. Then,
\[
h\in H(L)\mbox{ implies }\varphi_c(h)\land \psi'_{ob}\mbox{ is satisfiable.}
\]

\end{theorem}

\begin{proof}

Let $h=\tup{O,<,f}$. By Lemma~\ref{lemma:pending_histories}, there exists $h_1=\tup{O_1,<_1,f_1}$  %and~\ref{lemma:kernel_histories}
a completion of $h$  such that %and $h'\in H(\ker L)$
$h\preceq_c h_1$ and $h_1\in H(L)$. Also, by Theorem~\ref{th:satisfiability}, we get that
\[
\varphi(h_1)\land \<Dom>(O_1)\land \psi'\mbox{ is satisfiable}.
\]

We show that the following entailment holds
\begin{align}\label{eq:entailment}
\big(\varphi(h_1)\land \<Dom>(O_1)\land \psi'\big) => (\varphi_c(h)\land \psi'_{ob}),
\end{align}
which implies that the right-hand side of the entailment is also satisfiable.

Let $\tup{h_2,\poker}$ be a model of the left-hand side formula. Since all
the constraints in $\varphi_c(h)$ are included in $\varphi(h_1)$ (as a completion of $h$, 
$h_1$ preserves the complete operations in $h$ with the same labeling and the same
order constraints), $\tup{h_2,\poker}$ is a model of $\varphi_c(h)$. 

Let $\varphi::=\forall \vec{x}\ \exists \vec{y}.\ F$ and
$
\psi'::=< \subseteq \hspace{-1mm}\poker 
\land \<PO>(\poker)\land \varphi
$. We prove that 
\[
\tup{h_2,\poker}\models \psi'_{ob}::=< \subseteq \hspace{-1mm}\poker 
\land \<PO>(\poker)\land \varphi_{ob}.
\]
The first two conjuncts of $\psi'_{ob}$ are clearly satisfied by $\tup{h_2,\poker}$ since
they are also included in $\psi'$.

Since $h_2\in H(L)$, by Lemma~\ref{lemma:pref_obsolete}, there exists a prefix $h_3=(O_3,<_3,f_3)$
of $h_2$ that includes all the obsolete operations of $h$ and no pending operation of $h$
such that $h_3\in H(L)$. Therefore, there exists $\poker'$ such that $(O_3,\poker',f_3)$ is
a prefix of $(O_2,\poker,f_2)$ and 
\[
\tup{h_3,\poker'}\models \varphi(h_3)\land \<Dom>(O_3)\land \psi',
\]
and in particular, $\tup{h_3,\poker'}\models \<Dom>(O_3)\land \varphi$. The latter
implies that
\[
\tup{h_3,\poker'}\models 
\forall \vec{x}\ \exists \vec{y}.\ \bigwedge_{x\in\vec{x}}\ x\in O_3 => \big(\bigwedge_{y\in\vec{y}}\ y\in O_3 \land F\big).
\]

Let $O_{ob}$ be the set of obsolete operations of $h$. % and $O_c$ the set of complete operations of $h$. 
Since $O_{ob}\subseteq O_3$, we get that 
\[
\tup{h_3,\poker'}\models 
\forall \vec{x}\ \exists \vec{y}.\ \bigwedge_{x\in\vec{x}}\ x\in O_{ob} => \big(\bigwedge_{y\in\vec{y}}\ y\in O_3 \land F\big).
\]
Now, because $h_3$ is a prefix of $h_2$ and $(O_3,\poker',f_3)$ is a prefix of $(O_2,\poker,f_2)$, we get that
\[
\tup{h_2,\poker}\models 
\forall \vec{x}\ \exists \vec{y}.\ \bigwedge_{x\in\vec{x}}\ x\in O_{ob} => \big(\bigwedge_{y\in\vec{y}}\ y\in O_3 \land F\big).
\]

Let $O_c$ be the set of complete operations of $h$. Since $O_3\subseteq O_c$, we get that
\[
\tup{h_2,\poker}\models 
\forall \vec{x}\ \exists \vec{y}.\ \bigwedge_{x\in\vec{x}}\ x\in O_{ob} => \big(\bigwedge_{y\in\vec{y}}\ y\in O_c \land F\big).
\]
Therefore, $\tup{h_2,\poker}\models \varphi_{ob}$, which concludes the proof.
\end{proof}

\begin{example}

The reverse of this theorem doesn't hold.

\end{example}

The satisfiability of the formula $\varphi_c(h)\land \psi'_{ob}$ can be reduced to propositional satisfiability
as it was the case for the formula in Theorem~\ref{th:satisfiability}. Again, the interpretation domain
of the existentially-quantified variables is fixed, and the existential quantifiers can be replaced with
finite disjunctions. The obtained formula falls also in the EPR fragment of first-order logic and there
exists a boolean formula $\<ToBool>_{ob}(h,\psi)$, which is equi-satisfiable to $\varphi_c(h)\land \psi'_{ob}$.

\begin{corollary}\label{cor:satisfiability}

Let $L$ be a library such that $\ker L$ is defined and the operations of any execution in $\ker L$ are completed.
Also, let $\psi::=\exists\poker.\ \psi'$ be a formula as in Figure~\ref{fig:logic} describing the set of 
complete histories $H_c(L)$. Then,
\[
h\in H(L)\mbox{ implies }\<ToBool>_{ob}(h,\psi)\mbox{ is satisfiable.}
\]
\end{corollary}

\begin{example}

Show that the reduction in Theorem 2 is incomplete. A history with pending operations which is not linearizable but
the formula is satisfiable. 

One hopes that the history is extensible, that all pending operations become completed and then, detect the violation.

\end{example}

\subsection{Removing Matching Clusters}\label{ssec:removal}

The following result shows that removing a matching cluster from a history 
$h\in H(L)$ results in a history that also belongs to $H(L)$, 
provided that the same closure property holds for the set of kernel histories 
$H(\ker L)$.


\begin{theorem}\label{th:removing_matching}

Let $L$ be a library for which $\ker L$ is defined. If $H(\ker L)$ is $\<Matching>$-closed, 
then $H(L)$ is also $\<Matching>$-closed.

\end{theorem}

\begin{proof}

Let $h$ be a history of $H(L)$. 
By Lemmas~\ref{lemma:kernel_histories} and~\ref{lemma:pending_histories}, 
there exists a completion $h_{c}$ and a kernel history $h'\in H(\ker L)$ such that
$h\preceq_c h_{c} \preceq h'$. Also, let $O_1$ be a matching cluster of $h$.
Since all the operations in $O_1$ are completed, they are included in $h'$ with the
same labeling. By hypothesis, $H(\ker L)$ is $\<Matching>$-closed and therefore, 
$h'\setminus O_1\in H(\ker L)$. By the definition of $\preceq$, it follows that
$h_{c}\setminus O_1\preceq h'\setminus O_1$ and since the operations in $O_1$
are completed, we get that $h\setminus O_1\preceq h_{c}\setminus O_1$. Consequently,
$h\setminus O_1\in H(L)$.
\end{proof}

Theorem~\ref{th:removing_matching} provides soundness guarantees for   
a monitor that instead of checking whether the tracked history belongs to $H(L)$,
checks whether a smaller history, obtained from $h$ by removing all matching clusters,
belongs to $H(L)$. In order to define a monitor that is allowed to remove
the matching clusters from the tracked history, either the matching relation $\<Matching>$
is injective or one needs to impose supplementary
conditions on the removed clusters. When the matching function is not injective, 
a matching cluster of a history $h$ could be strictly included in a 
matching cluster of an extension of $h$. Therefore, removing it, may make the 
extension of the history without the matching cluster a spurious violation.

\begin{figure}

\input figures/removal_even_saturation

\caption{Removing the matching cluster $\{{\tt write}(1),{\tt read}=>1\}$ formed of obsolete operations.}
\label{fig:removal_even_saturation}

\end{figure}

\begin{example}\label{ex:removal_even_saturation}

Figure~\ref{fig:removal_even_saturation} pictures two histories $h$ and $h'$, the latter being an
extension of the former. Note that the matching cluster $\{\<write>(1),\<read>=>1\}$ of $h$
is strictly included in the cluster $\{\<write>(1),\<read>=>1,\<read>=>(1)\}$ of $h'$. 
Removing the cluster of $h$ and extending it with the $\<read>=>(1)$ operation
results in a spurious violation.

\end{example}

\begin{definition}

A matching cluster $O$ of a history $h$ is called \emph{obsolete} iff 

\begin{itemize}

	\item $\<Matching>$ is injective or

	\item there exists another matching cluster $O'$ of $h$ such that the positive operation in $O'$
	is obsolete and ordered after the positive operation in $O$

\end{itemize}

\end{definition}

\begin{lemma}

Let $L$ be a library such that for every two matching clusters $O_1$ and $O_2$ of a kernel history 
$h=\tup{O,<,f}$, $o_1<o_2$ for each $o_1\in O_1$ and $o_2\in O_2$. 
Also, let $h\in H(L)$ and $h'\in H(L)$ an extension of $h$. Then, there exists no matching cluster $O$ 
of $h'$, which strictly includes an obsolete matching cluster of $h$.

\end{lemma}

\begin{figure}

\input figures/complete_removal

\caption{Removing the matching cluster $\{{\tt push}(2),{\tt pop}=>2\}$ formed of complete but not obsolete operations.}
\label{fig:complete_removal}

\end{figure}

While the statement of Theorem~\ref{th:removing_matching} implies that a history
$h\setminus O$, where $O$ is a matching cluster in $h$, belongs to $H(L)$ whenever $h\in H(L)$,
Example~\ref{ex:complete_removal} shows that the reverse is not true. Consequently, 
a monitor that eagerly removes all matching clusters from the history it tracks 
may miss some violations.

\begin{example}\label{ex:complete_removal}

Figure~\ref{fig:complete_removal} pictures two histories $h$ and $h'$, the latter being an
extension of the former. The history obtained by removing the 
matching cluster $\{{\tt push}(2),{\tt pop}=>2\}$ from $h'$ belongs to $H(L_{stacks})$ while
$h'\not\in H(L_{stacks})$. Therefore, a monitor that removes all 
matching clusters when reading $h$, will miss the violation $h'$. Note that $h$ is not
a violation since $h\in H(L_{stacks})$.

\end{example}

One way to avoid the incompleteness exhibited by Example~\ref{ex:complete_removal}
is to remove a matching cluster only if it consists of obsolete operations.
Example~\ref{ex:removal_no_saturation} shows that even this strategy is incomplete.
Intuitively, this happens because the monitor doesn't remember any constraints
on the kernel order implied by the presence of the matching cluster.

\begin{figure}

\input figures/removal_no_saturation

\caption{Removing the matching cluster $\{{\tt push}(1),{\tt pop}=>1\}$ formed of obsolete operations.}
\label{fig:removal_no_saturation}

\end{figure}

\begin{example}\label{ex:removal_no_saturation}

Figure~\ref{fig:removal_no_saturation} pictures two histories $h$ and $h'$, the latter being an
extension of the former. Even though the matching cluster $\{{\tt push}(1),{\tt pop}=>1\}$
consists only of obsolete operations, removing it from the history $h'\not\in H(L_{stacks})$ 
results in a history $h$ which is not anymore a violation, since $h\in H(L_{stacks})$.
In order to detect this violation, the monitor should remember the constraint
$\<push>(2) \poker \<pop>=>Empty$ implied by the presence of this matching cluster.

\end{example}











