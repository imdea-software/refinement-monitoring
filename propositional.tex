%!TEX root = head.tex

\section{Refinement via Propositional Reasoning}
\label{sec:propositional}

In this section we demonstrate that the history membership problem $h \in
\overline{H}$ reduces to propositional satisfiability, given a formula
$\textsc{Theory}(H)$ characterizing the histories of the library kernel $H$.
Note that $h \in \overline{H}$ if{f} $h$ is weaker than some history $h' \in
H$, or equivalently weaker than some history $h' |= \textsc{Theory}(H)$. When
$h$ is complete, the fact that any stronger history contains exactly the same
set of operations enables the construction of a formula $\textsc{Stronger}(h)$
characterizing the histories stronger than $h$. Together with
$\textsc{Theory}(H)$, this formula describes all stronger histories satisfying
$\textsc{Theory}(H)$, and is therefore equivalent to $h \in H(L)$. We show how
to construct these formul\ae in Section~\ref{sec:propositional:complete}.

When $h$ contains pending operations, stronger histories $h'$ may contain fewer
operations, since some pending operations of $h$ may be omitted in $h'$, and
others completed. In this case the joint satisfiability of $\textsc{Theory}(H)$
and $\textsc{Stronger}(h)$ must be enhanced with additional constraints to
ensure that the operations of $h'$ include at least the completed operations of
$h$, and possibly some pending operations of $h$. We tackle this problem in
Section~\ref{sec:propositional:pending}.

\subsection{Complete Histories}
\label{sec:propositional:complete}

The following lemma characterizes the weaker than relation between
histories. It states that a history $h'$ stronger than a complete history $h$
can only differ in having more order constraints between the operations, the
operation labels being the same in $h$ and $h'$.

%\begin{lemma}
%
%Let $h_1=\tup{O_1,<_1,f_1}$ and $h_2=\tup{O_2,<_2,f_2}$ be two histories. If $h_1\preceq_g h_2$ then
%for every two completed operations $o_1, o_2\in O_1$, 
%\[
%\<Matching>(h_1)(o_1)=o_2\text{ iff }\<Matching>(h_2)(g^{-1}(o_1))=g^{-1}(o_2).
%\]
%
%\end{lemma}

\begin{lemma}
  \label{lemma:complete_history}

  A complete history $h=\tup{O,<,f}$ is weaker than another history
  $h'=\tup{O',<',f'}$ iff there exists a bijection $g:O'->O$ such that:

  \begin{itemize}

    \item operations related by $g$ have the same label, i.e., for each $o\in O$, $f(o)=f'(g^{-1}(o))$, and

    \item order constraints are preserved from $h$ to $h'$, i.e., for each $o,o'\in O$, $o< o'$ implies $g^{-1}(o)<' g^{-1}(o')$.

%    \item the matching function is the same for the two histories, i.e., for each $o,o'\in O_1$, $\<Matching>(h_1)(o)=o'$ iff $\<Matching>(h_2)(g^{-1}(o))=g^{-1}(o')$.

  \end{itemize}

\end{lemma}

We characterize histories stronger than $h$ by the formula $\textsc{Stronger}(h)$, defined as
the conjunction
\begin{align*}
  %\textsc{Match}(M,h) /| 
  \textsc{Domain}(h) /| \textsc{Labels}(h) /| \textsc{Order}(h)
\end{align*}
using the formul\ae of Figure~\ref{fig:formula:history} characterizing the
%matching function, 
identifiers, labels, and order constraints of $h$. Note that
the $\textsc{Domain}(h)$ formula restricts the interpretation domain of each
variable to the operations of $h$. As a consequence of
Lemma~\ref{lemma:complete_history}, the formula $\textsc{Stronger}(h)$ does
indeed characterize all histories at least as strong as $h$.

\begin{figure}
  \footnotesize
  \begin{align*}
%    & \textsc{Match}(M,h)
%    && \bigwedge_{o_1 = M_h(o_2)} {\sf match}(o_1,o_2) \\
    & \textsc{Domain}(h)
    && \bigwedge_{o_1, o_2 \in O} o_1 \neq o_2 /| \forall x.\ \bigvee_{o\in O} x = o \\
    & \textsc{Labels}(h)
    && \hspace{-5mm} \bigwedge_{f(o) = (m(u) => v)}
      \hspace{-5mm}
      {\sf meth}(o) = m /| {\sf arg}(o) = u /| 
      [{\sf ret}(o) = v]_{v \neq \bot} \\
    & \textsc{Order}(h)
    && \bigwedge_{o_1 < o_2} {\sf b}(o_1, o_2)
  \end{align*}
  \caption{Formul\ae characterizing histories $h = \tup{O,<,f}$.}
  \label{fig:formula:history}
\end{figure}

\begin{lemma}
  \label{lem:stronger_form_complete}
  
  Let $h$ and $h'$ be histories.
  Then $h \preceq h'$ if{f} $h' |= \textsc{Stronger}(h)$.

\end{lemma}

\noindent
It follows that the library membership test $h \in \overline{H}$ for complete
histories $h$ reduces to first-order satisfiability.

\begin{theorem}
  \label{th:satisfiability_pending}

  Let $h$ be a complete history, and $H$ a history set.
  Then $h \in \overline{H}$ if{f}
  $\textsc{Stronger}(h) /| \textsc{Theory}(H)$ is satisfiable.

\end{theorem}

As long as the formula $\textsc{Theory}(H)$ contains only a fixed set of
predicates e.g.,~$=$ and $\leq$, as is the case for all formul\ae of
Figures~\ref{fig:formulas:common}--\ref{fig:formulas:synchronization},
satisfiability of $\textsc{Stronger}(h) /| \textsc{Theory}(H)$ reduces to
propositional satisfiability. Intuitively this holds since the domain of
(quantified) variables is restricted to operations appearing in $h$. Thus for a
given $h$ and $H$, we construct the propositional formula
$\db{\textsc{Stronger}(h) /| \textsc{Theory}(H)}$ by replacing each
universally-quantified subformula $\forall x. @p$ by $\bigwedge_{o \in O} @p[x
|-> o]$, and each existentially-quantified subformula $\exists x. @p$ by
$\bigvee_{o \in O} @p[x |-> o]$. It follows that this propositional formula is
equisatisfiable to the original first-order formula, and is constructed in
polynomial time.

\begin{corollary}
  \label{cor:satisfiability_complete}

  Let $h$ be a complete history, and $H$ a history set.
  Then $h \in \overline{H}$ if{f} the propositional formula
  $$\db{\textsc{Stronger}(h) /| \textsc{Theory}(H)}$$
  is satisfiable.

\end{corollary}

\subsection{Histories with Pending Operations}
\label{sec:propositional:pending}

The pending operations of a history $h$ may be omitted in a stronger history or
they may be completed with arbitrary return values. 
Therefore, 
%Since in general two comparable histories (w.r.t. the weaker than relation)
%may consist of different sets of operations 
%In the general case, 
the set of histories stronger than a history $h$
can be characterized by a formula obtained from $\textsc{Stronger}(h)$ by
adding a domain predicate ${\sf used}$ that is constrained to contain all the
completed operations of $h$ and by omitting the constraints on the return
values of pending operations. Moreover, every operation of $h$ whose return
value is different from $\bot$ in a model of this formula (this may be an
operation which is pending in $h$) should satisfy ${\sf used}$. It can be
proved that every history stronger than $h$ corresponds to a model of this
formula, projected on the set of operations satisfying ${\sf used}$.

We define the formula {\sc Used} as
\begin{align*}
  \forall x.\ {\sf ret}(x) \neq \bot => {\sf used}(x)
\end{align*}

For arbitrary, not necessarily complete, histories $h$, the models of
$\textsc{Stronger}(h)$ are histories paired with an interpretation $U : O ->
\<Bools>$ for the domain predicate ${\sf used}$, mapping the operations $O$ of
$h$ to $\set{\sf true, false}$ . Given such a model $\tup{h,U}$, let $U(h)$ be
the history obtained from $h$ by deleting operations $o$ such that $\lnot U(o)$.

\begin{lemma}
  \label{lem:stronger_form_pending}

  Let $h$ and $h'$ be histories, and $U : O' -> \<Bools>$.
  Then $h', U |= \textsc{Stronger}(h)$ if{f} $h \preceq U(h')$.

\end{lemma}

We leverage the predicate {\sf used} to guard the domain of quantifiers in
$\textsc{Theory}(H)$. For simplicity, we assume that $\textsc{Theory}(H)$ is
given in prenex normal form, whose quantifiers form a prefix $\forall^*
\exists^*$. All of the formul\ae of
Figures~\ref{fig:formulas:common}--\ref{fig:formulas:synchronization} can be
written in this form. We thus define the guarded formula $G(@p)$ of the formula
$@p = \forall \vec{x}. \exists \vec{y}. @y$ as
\begin{align*}
  G(@p) = \forall \vec{x}. \exists \vec{y}.
  \bigwedge_{x \in \vec{x}} {\sf used}(x) => 
  \bigvee_{y \in \vec{y}} {\sf used}(y) /| @y
\end{align*}
As usual, universal quantifiers are guarded using implication and existential
quantifiers using conjunction. It follows from
Lemma~\ref{lem:stronger_form_pending} that history membership reduces to
first-order satisfiability.

\begin{theorem}
  \label{th:satisfiability_complete}

  Let $h$ be a history, and $H$ a history set. Then $h \in \overline{H}$ if{f}
  the first-order formula
  $$\textsc{Stronger}(h) /| \textsc{Used} /| G(\textsc{Theory}(H))$$
  is satisfiable.

\end{theorem}

We again reduce this first-order satisfiability problem to propositional
satisfiability by limiting the domain of quantifiers to the operations of $h$
via the function $\db{\cdot}$.

\begin{corollary}
  \label{cor:satisfiability_pending}

  Let $h$ be a history, and $H$ a history set. Then $h \in \overline{H}$ if{f}
  the propositional formula
  $$\db{\textsc{Stronger}(h) /| \textsc{Used} /| G(\textsc{Theory}(H))}$$
  is satisfiable.

\end{corollary}
